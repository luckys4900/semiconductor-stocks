<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—¥æœ¬åŠå°ä½“æ ªã‚¦ã‚©ãƒƒãƒãƒ£ãƒ¼</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Sans","Yu Gothic UI",sans-serif;background:#0b0d14;color:#dde1f0;min-height:100vh}

    /* ===== HEADER ===== */
    header{background:#12151f;border-bottom:1px solid #1e2236;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
    .logo{display:flex;align-items:center;gap:10px}
    .logo-icon{width:30px;height:30px;background:linear-gradient(135deg,#4f8ef7,#9b59f7);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
    .logo h1{font-size:17px;font-weight:700;color:#fff;letter-spacing:-.3px}
    .logo small{font-size:11px;color:#555;margin-left:6px}
    #clock{font-size:12px;color:#555;font-variant-numeric:tabular-nums}

    /* ===== MARKET BAR ===== */
    .market-bar{background:#0e1120;border-bottom:1px solid #1a1d2e;padding:8px 24px;display:flex;gap:28px;overflow-x:auto;scrollbar-width:none}
    .market-bar::-webkit-scrollbar{display:none}
    .mitem{display:flex;align-items:center;gap:8px;white-space:nowrap;font-size:13px}
    .mitem .mlabel{color:#555;font-size:11px}
    .mitem .mval{font-weight:600;color:#ccc}
    .mitem .mchg{font-size:11px;padding:2px 6px;border-radius:4px;font-weight:600}
    .up{color:#2ecc71}.down{color:#e74c3c}.neutral{color:#888}
    .bg-up{background:rgba(46,204,113,.12);color:#2ecc71}
    .bg-down{background:rgba(231,76,60,.12);color:#e74c3c}
    .bg-neutral{background:rgba(136,136,136,.12);color:#888}
    .divider{width:1px;background:#1e2236;margin:0 4px}

    /* ===== CONTAINER ===== */
    .container{max-width:1100px;margin:0 auto;padding:20px 16px;display:grid;gap:20px}

    /* ===== FOCUS CARDS (6857/6871/6855) ===== */
    .focus-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .focus-card{background:linear-gradient(145deg,#141828,#111522);border:1px solid #222640;border-radius:12px;padding:18px;cursor:pointer;transition:border-color .2s,transform .15s;position:relative;overflow:hidden}
    .focus-card::before{content:"";position:absolute;top:0;left:0;right:0;height:3px;border-radius:12px 12px 0 0}
    .focus-card.f1::before{background:linear-gradient(90deg,#4f8ef7,#60a5fa)}
    .focus-card.f2::before{background:linear-gradient(90deg,#9b59f7,#c084fc)}
    .focus-card.f3::before{background:linear-gradient(90deg,#f7924f,#fbbf78)}
    .focus-card:hover{border-color:#333860;transform:translateY(-2px)}
    .fc-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
    .fc-ticker{font-size:20px;font-weight:800;color:#fff;letter-spacing:-.5px}
    .fc-name{font-size:11px;color:#555;margin-top:2px;line-height:1.4}
    .fc-badge{font-size:10px;background:#1e2236;color:#666;padding:3px 8px;border-radius:20px}
    .fc-price{font-size:28px;font-weight:800;color:#fff;letter-spacing:-1px;margin-bottom:6px}
    .fc-price span{font-size:14px;font-weight:400;color:#555;margin-left:2px}
    .fc-change{display:inline-flex;align-items:center;gap:4px;font-size:13px;font-weight:600;padding:3px 10px;border-radius:6px;margin-bottom:10px}
    .fc-meta{display:flex;gap:12px}
    .fc-meta-item{font-size:11px;color:#555}.fc-meta-item b{color:#888;display:block;font-size:10px;margin-bottom:1px}

    /* ===== API STATUS ===== */
    .api-status{display:inline-flex;align-items:center;gap:5px;font-size:10px;font-weight:600;padding:2px 8px;border-radius:20px;margin-bottom:8px}
    .api-status.loading{background:rgba(79,142,247,.12);color:#4f8ef7}
    .api-status.live{background:rgba(46,204,113,.12);color:#2ecc71}
    .api-status.error{background:rgba(231,76,60,.12);color:#e74c3c}
    .api-status .dot-pulse{width:6px;height:6px;border-radius:50%;background:currentColor;animation:pulse 1.2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
    .api-error-box{background:rgba(231,76,60,.07);border:1px solid rgba(231,76,60,.2);border-radius:8px;padding:10px 12px;margin-top:8px;font-size:11px;color:#e74c3c;line-height:1.55;display:none}
    .api-error-box .err-title{font-weight:700;margin-bottom:4px}
    .yf-link{display:inline-flex;align-items:center;gap:5px;font-size:11px;color:#4f8ef7;text-decoration:none;margin-top:10px;padding:4px 10px;border:1px solid rgba(79,142,247,.25);border-radius:6px;transition:background .2s}
    .yf-link:hover{background:rgba(79,142,247,.1)}
    .mock-badge{font-size:10px;background:rgba(247,183,79,.12);color:#f7b74f;border:1px solid rgba(247,183,79,.2);padding:2px 8px;border-radius:4px;font-weight:600;vertical-align:middle;margin-left:8px}

    /* ===== SEARCH + CONTROLS ===== */
    .controls{display:flex;gap:10px;align-items:center}
    .search-wrap{position:relative;flex:1}
    .search-wrap input{width:100%;background:#141828;border:1px solid #1e2236;border-radius:8px;padding:10px 14px 10px 36px;color:#dde1f0;font-size:14px;outline:none;transition:border-color .2s}
    .search-wrap input:focus{border-color:#4f8ef7}
    .search-wrap input::placeholder{color:#444}
    .search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:#444;font-size:15px;pointer-events:none}
    .refresh-btn{background:#4f8ef7;border:none;border-radius:8px;padding:10px 18px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:background .2s;white-space:nowrap}
    .refresh-btn:hover{background:#3a7ae0}
    .refresh-btn:active{transform:scale(.97)}

    /* ===== SUMMARY ===== */
    .summary-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .scard{background:#141828;border:1px solid #1e2236;border-radius:10px;padding:14px}
    .scard .sl{font-size:11px;color:#555;margin-bottom:6px;text-transform:uppercase;letter-spacing:.05em}
    .scard .sv{font-size:22px;font-weight:700;color:#fff}
    .scard .ss{font-size:11px;margin-top:3px}

    /* ===== TABLE ===== */
    .table-wrap{background:#141828;border:1px solid #1e2236;border-radius:12px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    thead tr{background:#0e1120}
    th{padding:11px 16px;font-size:11px;font-weight:600;color:#555;text-align:left;text-transform:uppercase;letter-spacing:.06em;cursor:pointer;user-select:none;white-space:nowrap}
    th:hover{color:#999}
    th.r,td.r{text-align:right}
    tbody tr{border-top:1px solid #181d2e;transition:background .15s;cursor:pointer}
    tbody tr:hover{background:#1a2038}
    tbody tr.highlight-row{border-left:3px solid #4f8ef7}
    td{padding:13px 16px;font-size:13px}
    .t-ticker{font-weight:700;color:#fff;font-size:14px}
    .t-name{font-size:11px;color:#555;margin-top:2px}
    .t-star{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:6px;vertical-align:middle}
    .t-price{font-weight:600;color:#e8eaf6;font-variant-numeric:tabular-nums}
    .badge{display:inline-flex;align-items:center;gap:3px;font-size:12px;font-weight:600;padding:2px 9px;border-radius:6px}
    .bar-wrap{width:80px;height:6px;background:#1e2236;border-radius:3px;margin-left:auto}
    .bar-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,#4f8ef7,#9b59f7)}
    .sa{font-size:9px;opacity:.4}.sa.active{opacity:1;color:#4f8ef7}

    /* ===== NEWS / EVENTS ===== */
    .section-title{font-size:14px;font-weight:700;color:#fff;margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .section-title .dot{width:8px;height:8px;border-radius:50%;background:#4f8ef7;flex-shrink:0}

    .news-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .news-card{background:#141828;border:1px solid #1e2236;border-radius:10px;padding:16px;transition:border-color .2s}
    .news-card:hover{border-color:#2a2f50}
    .news-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:8px}
    .news-title{font-size:13px;font-weight:600;color:#e0e4f0;line-height:1.45;flex:1}
    .news-date{font-size:11px;color:#444;white-space:nowrap}
    .news-body{font-size:12px;color:#666;line-height:1.6;margin-bottom:12px}
    .news-impact{display:flex;flex-wrap:wrap;gap:6px}
    .impact-chip{font-size:11px;font-weight:600;padding:3px 9px;border-radius:20px;display:inline-flex;align-items:center;gap:4px}
    .imp-up{background:rgba(46,204,113,.12);color:#2ecc71;border:1px solid rgba(46,204,113,.2)}
    .imp-down{background:rgba(231,76,60,.12);color:#e74c3c;border:1px solid rgba(231,76,60,.2)}
    .imp-neutral{background:rgba(136,136,136,.1);color:#888;border:1px solid rgba(136,136,136,.15)}
    .imp-watch{background:rgba(79,142,247,.1);color:#4f8ef7;border:1px solid rgba(79,142,247,.2)}
    .news-cat{font-size:10px;text-transform:uppercase;letter-spacing:.06em;padding:2px 7px;border-radius:4px;font-weight:600}
    .cat-demand{background:rgba(155,89,247,.15);color:#9b59f7}
    .cat-macro{background:rgba(247,183,79,.15);color:#f7b74f}
    .cat-supply{background:rgba(46,204,113,.15);color:#2ecc71}
    .cat-policy{background:rgba(79,142,247,.15);color:#4f8ef7}
    .cat-earnings{background:rgba(231,76,60,.15);color:#e74c3c}

    /* ===== FACTOR PANEL ===== */
    .factor-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .factor-card{background:#141828;border:1px solid #1e2236;border-radius:10px;padding:14px}
    .factor-label{font-size:11px;color:#555;margin-bottom:4px;text-transform:uppercase;letter-spacing:.06em}
    .factor-val{font-size:15px;font-weight:700;margin-bottom:6px}
    .factor-desc{font-size:11px;color:#555;line-height:1.5}
    .meter{height:4px;background:#1e2236;border-radius:2px;margin:8px 0}
    .meter-fill{height:100%;border-radius:2px;transition:width .5s}
    .meter-fill.up{background:linear-gradient(90deg,#27ae60,#2ecc71)}
    .meter-fill.down{background:linear-gradient(90deg,#c0392b,#e74c3c)}
    .meter-fill.neutral{background:linear-gradient(90deg,#555,#888)}

    /* ===== ROW API STATUS ===== */
    .row-status{font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px;vertical-align:middle;margin-left:5px;display:inline-block}
    .row-status.pending{background:rgba(79,142,247,.12);color:#4f8ef7;animation:blink 1.4s infinite}
    .row-status.live{background:rgba(46,204,113,.12);color:#2ecc71}
    .row-status.error{background:rgba(231,76,60,.12);color:#e74c3c}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
    .tbl-status-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px}
    .tbl-status-desc{font-size:11px;color:#555;margin-bottom:12px}

    /* ===== NO RESULTS ===== */
    .no-results{text-align:center;padding:40px;color:#444;font-size:13px}

    /* ===== RESPONSIVE ===== */
    @media(max-width:750px){
      .focus-cards{grid-template-columns:1fr;gap:10px}
      .summary-row{grid-template-columns:repeat(2,1fr)}
      .news-grid{grid-template-columns:1fr}
      .factor-grid{grid-template-columns:1fr 1fr}
      td.hide-sm,th.hide-sm{display:none}
    }
    @media(max-width:500px){
      .factor-grid{grid-template-columns:1fr}
      .summary-row{grid-template-columns:1fr 1fr}
    }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">åŠ</div>
    <div>
      <h1>æ—¥æœ¬åŠå°ä½“æ ªã‚¦ã‚©ãƒƒãƒãƒ£ãƒ¼ <small>Japan Semiconductor Watch</small></h1>
    </div>
  </div>
  <div id="clock">--:--:--</div>
</header>

<!-- MARKET BAR -->
<div class="market-bar">
  <div class="mitem"><span class="mlabel">SOX</span><span class="mval" id="sox-val">4,821</span><span class="mchg bg-up" id="sox-chg">+1.23%</span></div>
  <div class="divider"></div>
  <div class="mitem"><span class="mlabel">USD/JPY</span><span class="mval" id="usdjpy-val">152.40</span><span class="mchg bg-down" id="usdjpy-chg">-0.28%</span></div>
  <div class="divider"></div>
  <div class="mitem"><span class="mlabel">æ—¥çµŒ225</span><span class="mval" id="nk-val">38,720</span><span class="mchg bg-up" id="nk-chg">+0.45%</span></div>
  <div class="divider"></div>
  <div class="mitem"><span class="mlabel">NASDAQ</span><span class="mval" id="nq-val">19,850</span><span class="mchg bg-up" id="nq-chg">+0.82%</span></div>
  <div class="divider"></div>
  <div class="mitem"><span class="mlabel">TSMC ADR</span><span class="mval" id="tsm-val">$182.40</span><span class="mchg bg-up" id="tsm-chg">+1.54%</span></div>
  <div class="divider"></div>
  <div class="mitem"><span class="mlabel">NVDA</span><span class="mval" id="nvda-val">$875.20</span><span class="mchg bg-up" id="nvda-chg">+3.21%</span></div>
</div>

<div class="container">

  <!-- FOCUS CARDS -->
  <div>
    <div class="section-title" style="justify-content:space-between;flex-wrap:wrap;gap:8px">
      <div style="display:flex;align-items:center;gap:8px"><div class="dot"></div>æ³¨ç›®éŠ˜æŸ„ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ ªä¾¡ï¼‰</div>
      <button class="refresh-btn" style="font-size:12px;padding:6px 14px" onclick="fetchAllPrices()">â†º APIå†å–å¾—</button>
    </div>
    <div class="focus-cards">

      <!-- 6857 -->
      <div class="focus-card f1" id="card-6857">
        <div class="fc-header">
          <div><div class="fc-ticker">6857</div><div class="fc-name">ã‚¢ãƒ‰ãƒãƒ³ãƒ†ã‚¹ãƒˆ<br>åŠå°ä½“ãƒ†ã‚¹ãƒˆè£…ç½®</div></div>
          <span class="fc-badge">ãƒ†ã‚¹ãƒˆè£…ç½®</span>
        </div>
        <div class="api-status loading" id="st6857"><span class="dot-pulse"></span>å–å¾—ä¸­...</div>
        <div class="fc-price" id="p6857">-- <span>å††</span></div>
        <div class="fc-change bg-neutral neutral" id="c6857">--</div>
        <div class="fc-meta" id="m6857">
          <div class="fc-meta-item"><b>å‰æ—¥çµ‚å€¤</b><span id="prev6857">--</span></div>
          <div class="fc-meta-item"><b>ãƒ‡ãƒ¼ã‚¿å…ƒ</b>Yahoo Finance</div>
        </div>
        <div class="api-error-box" id="err6857">
          <div class="err-title">å–å¾—ã‚¨ãƒ©ãƒ¼</div>
          <div id="errmsg6857"></div>
        </div>
        <a class="yf-link" href="https://finance.yahoo.co.jp/quote/6857.T" target="_blank" rel="noopener">
          Yahoo Finance ã§ç¢ºèª â†—
        </a>
      </div>

      <!-- 6871 -->
      <div class="focus-card f2" id="card-6871">
        <div class="fc-header">
          <div><div class="fc-ticker">6871</div><div class="fc-name">æ—¥æœ¬ãƒã‚¤ã‚¯ãƒ­ãƒ‹ã‚¯ã‚¹<br>ãƒ—ãƒ­ãƒ¼ãƒ–ã‚«ãƒ¼ãƒ‰</div></div>
          <span class="fc-badge">æ¤œæŸ»æ²»å…·</span>
        </div>
        <div class="api-status loading" id="st6871"><span class="dot-pulse"></span>å–å¾—ä¸­...</div>
        <div class="fc-price" id="p6871">-- <span>å††</span></div>
        <div class="fc-change bg-neutral neutral" id="c6871">--</div>
        <div class="fc-meta" id="m6871">
          <div class="fc-meta-item"><b>å‰æ—¥çµ‚å€¤</b><span id="prev6871">--</span></div>
          <div class="fc-meta-item"><b>ãƒ‡ãƒ¼ã‚¿å…ƒ</b>Yahoo Finance</div>
        </div>
        <div class="api-error-box" id="err6871">
          <div class="err-title">å–å¾—ã‚¨ãƒ©ãƒ¼</div>
          <div id="errmsg6871"></div>
        </div>
        <a class="yf-link" href="https://finance.yahoo.co.jp/quote/6871.T" target="_blank" rel="noopener">
          Yahoo Finance ã§ç¢ºèª â†—
        </a>
      </div>

      <!-- 6855 -->
      <div class="focus-card f3" id="card-6855">
        <div class="fc-header">
          <div><div class="fc-ticker">6855</div><div class="fc-name">æ—¥æœ¬é›»å­ææ–™<br>ãƒ—ãƒ­ãƒ¼ãƒ–ã‚«ãƒ¼ãƒ‰</div></div>
          <span class="fc-badge">æ¤œæŸ»æ²»å…·</span>
        </div>
        <div class="api-status loading" id="st6855"><span class="dot-pulse"></span>å–å¾—ä¸­...</div>
        <div class="fc-price" id="p6855">-- <span>å††</span></div>
        <div class="fc-change bg-neutral neutral" id="c6855">--</div>
        <div class="fc-meta" id="m6855">
          <div class="fc-meta-item"><b>å‰æ—¥çµ‚å€¤</b><span id="prev6855">--</span></div>
          <div class="fc-meta-item"><b>ãƒ‡ãƒ¼ã‚¿å…ƒ</b>Yahoo Finance</div>
        </div>
        <div class="api-error-box" id="err6855">
          <div class="err-title">å–å¾—ã‚¨ãƒ©ãƒ¼</div>
          <div id="errmsg6855"></div>
        </div>
        <a class="yf-link" href="https://finance.yahoo.co.jp/quote/6855.T" target="_blank" rel="noopener">
          Yahoo Finance ã§ç¢ºèª â†—
        </a>
      </div>

    </div>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="summary-row">
    <div class="scard"><div class="sl">ã‚¦ã‚©ãƒƒãƒéŠ˜æŸ„</div><div class="sv" id="s-total">-</div><div class="ss neutral">éŠ˜æŸ„</div></div>
    <div class="scard"><div class="sl">ä¸Šæ˜‡</div><div class="sv up" id="s-up">-</div><div class="ss up" id="s-up-p">-</div></div>
    <div class="scard"><div class="sl">ä¸‹è½</div><div class="sv down" id="s-dn">-</div><div class="ss down" id="s-dn-p">-</div></div>
    <div class="scard"><div class="sl">æœ€çµ‚æ›´æ–°</div><div class="sv" style="font-size:16px" id="s-time">--:--</div><div class="ss neutral">è‡ªå‹•æ›´æ–° 5ç§’</div></div>
  </div>

  <!-- SEARCH + TABLE -->
  <div>
    <div class="tbl-status-bar">
      <div class="section-title" style="margin-bottom:0">
        <div class="dot" style="background:#2ecc71"></div>
        åŠå°ä½“é–¢é€£éŠ˜æŸ„ä¸€è¦§
        <span id="tbl-status-badge" class="mock-badge">å–å¾—ä¸­...</span>
      </div>
      <button class="refresh-btn" style="font-size:12px;padding:6px 14px" onclick="fetchAllPrices()">â†º APIå†å–å¾—</button>
    </div>
    <div id="tbl-status-desc" class="tbl-status-desc">Yahoo Finance APIã‚ˆã‚Šæ ªä¾¡ãƒ»å‰æ—¥æ¯”ã‚’å–å¾—ä¸­... å‡ºæ¥é«˜ãƒ»æ™‚ä¾¡ç·é¡ã¯å‚è€ƒå€¤ã§ã™ã€‚</div>
    <div class="controls" style="margin-bottom:12px">
      <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="search" placeholder="éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ãƒ»éŠ˜æŸ„åã§æ¤œç´¢..." />
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th onclick="sort('ticker')">éŠ˜æŸ„ <span class="sa" id="sa-ticker">â–²</span></th>
            <th class="r" onclick="sort('price')">æ ªä¾¡ <span class="sa" id="sa-price">â–²</span></th>
            <th class="r" onclick="sort('change')">å‰æ—¥æ¯” <span class="sa" id="sa-change">â–²</span></th>
            <th class="r hide-sm" onclick="sort('volume')">å‡ºæ¥é«˜ <span class="sa" id="sa-volume">â–²</span></th>
            <th class="r hide-sm" onclick="sort('cap')">æ™‚ä¾¡ç·é¡ <span class="sa" id="sa-cap">â–²</span></th>
            <th class="r hide-sm">ã‚»ã‚¯ã‚¿ãƒ¼</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="no-results" id="no-results" style="display:none">éŠ˜æŸ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
    </div>
  </div>

  <!-- IMPACT FACTORS -->
  <div>
    <div class="section-title"><div class="dot" style="background:#9b59f7"></div>æ ªä¾¡æ³¢åŠãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ï¼ˆ6857ãƒ»6871ãƒ»6855ï¼‰</div>
    <div class="factor-grid" id="factors-grid"></div>
  </div>

  <!-- NEWS & EVENTS -->
  <div>
    <div class="section-title"><div class="dot" style="background:#f7b74f"></div>æ³¨ç›®ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ</div>
    <div class="news-grid" id="news-grid"></div>
  </div>

</div><!-- /container -->

<script>
// ===== STOCK DATA (yfSym = Yahoo Finance ticker) =====
const BASE = [
  {ticker:"6857",name:"ã‚¢ãƒ‰ãƒãƒ³ãƒ†ã‚¹ãƒˆ",         en:"Advantest",          yfSym:"6857.T", price:0,change:0,volume:4200000,cap:6300, sector:"ãƒ†ã‚¹ãƒˆè£…ç½®",      focus:true, color:"#4f8ef7"},
  {ticker:"8035",name:"æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³",        en:"Tokyo Electron",     yfSym:"8035.T", price:0,change:0,volume:2800000,cap:11050,sector:"è£½é€ è£…ç½®",        focus:false,color:"#2ecc71"},
  {ticker:"6146",name:"ãƒ‡ã‚£ã‚¹ã‚³",               en:"Disco",              yfSym:"6146.T", price:0,change:0,volume:420000, cap:1960, sector:"è£½é€ è£…ç½®",        focus:false,color:"#2ecc71"},
  {ticker:"6871",name:"æ—¥æœ¬ãƒã‚¤ã‚¯ãƒ­ãƒ‹ã‚¯ã‚¹",      en:"Nihon Micronics",    yfSym:"6871.T", price:0,change:0,volume:820000, cap:620,  sector:"ãƒ—ãƒ­ãƒ¼ãƒ–ã‚«ãƒ¼ãƒ‰",  focus:true, color:"#9b59f7"},
  {ticker:"6855",name:"æ—¥æœ¬é›»å­ææ–™",           en:"Japan Electronic M.",yfSym:"6855.T", price:0,change:0,volume:310000, cap:230,  sector:"ãƒ—ãƒ­ãƒ¼ãƒ–ã‚«ãƒ¼ãƒ‰",  focus:true, color:"#f7924f"},
  {ticker:"4063",name:"ä¿¡è¶ŠåŒ–å­¦å·¥æ¥­",           en:"Shin-Etsu Chemical", yfSym:"4063.T", price:0,change:0,volume:1600000,cap:11380,sector:"ã‚·ãƒªã‚³ãƒ³ã‚¦ã‚§ãƒ¼ãƒ", focus:false,color:"#1abc9c"},
  {ticker:"3436",name:"SUMCO",                  en:"SUMCO",              yfSym:"3436.T", price:0,change:0,volume:3200000,cap:2030, sector:"ã‚·ãƒªã‚³ãƒ³ã‚¦ã‚§ãƒ¼ãƒ", focus:false,color:"#1abc9c"},
  {ticker:"6723",name:"ãƒ«ãƒã‚µã‚¹ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ‹ã‚¯ã‚¹",en:"Renesas",            yfSym:"6723.T", price:0,change:0,volume:5800000,cap:4190, sector:"åŠå°ä½“è¨­è¨ˆ",      focus:false,color:"#e67e22"},
  {ticker:"6501",name:"æ—¥ç«‹è£½ä½œæ‰€",             en:"Hitachi",            yfSym:"6501.T", price:0,change:0,volume:3600000,cap:14300,sector:"é›»æ©Ÿãƒ»ç·åˆ",      focus:false,color:"#95a5a6"},
  {ticker:"6976",name:"å¤ªé™½èª˜é›»",               en:"Taiyo Yuden",        yfSym:"6976.T", price:0,change:0,volume:980000, cap:620,  sector:"é›»å­éƒ¨å“",        focus:false,color:"#e67e22"},
];

// ===== MARKET DATA (simulation base) =====
const MARKET={sox:{val:4821,chg:1.23},usdjpy:{val:152.40,chg:-0.28},nk:{val:38720,chg:0.45},nq:{val:19850,chg:0.82},tsm:{val:182.40,chg:1.54},nvda:{val:875.20,chg:3.21}};

// ===== NEWS DATA =====
const NEWS=[
  {cat:"cat-demand",catLabel:"éœ€è¦å‹•å‘",title:"HBM4é‡ç”£ç§»è¡ŒåŠ é€Ÿã€ãƒ†ã‚¹ãƒˆæ™‚é–“ãŒHBM3Eæ¯”ã•ã‚‰ã«é•·æœŸåŒ–",date:"2026-02-19",
   body:"SK HynixãŒHBM4ã®é‡ç”£ã‚’é–‹å§‹ã€‚ã‚¹ã‚¿ãƒƒã‚¯æ•°ã®å¢—åŠ ã§ãƒ€ã‚¤ç©å±¤ãƒ†ã‚¹ãƒˆãŒè¤‡é›‘åŒ–ã—ã€ãƒ†ã‚¹ãƒˆæ™‚é–“ãŒé€šå¸¸DRAMã®5ã€œ7å€ã«ã€‚ã‚¢ãƒ‰ãƒãƒ³ãƒ†ã‚¹ãƒˆã®T5503/T5503HãŒä¸»åŠ›ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨ã—ã¦æ¡ç”¨ç¶™ç¶šã€‚HBM4ã®æœ¬æ ¼æ™®åŠã§6857ã®å—æ³¨ãŒæ›´ã«ç©ã¿ä¸ŠãŒã‚‹è¦‹é€šã—ã€‚",
   impacts:[{label:"6857 â–²å¼·æ°—",cls:"imp-up"},{label:"6871 â–²ä¸­ç«‹ã€œå¼·æ°—",cls:"imp-up"},{label:"6855 â–²ä¸­ç«‹",cls:"imp-watch"}]},
  {cat:"cat-earnings",catLabel:"æ±ºç®—ãƒ»æ¥­ç¸¾",title:"NVIDIA Blackwell GB200é‡ç”£ãƒ•ãƒ«ç¨¼åƒã€ä¾›çµ¦é€¼è¿«ç¶šã",date:"2026-02-16",
   body:"NVIDIAã®Blackwell GB200 NVLã‚·ãƒªãƒ¼ã‚ºã®ä¾›çµ¦ãŒä¾ç„¶ä¸è¶³ã€‚TSMCã®CoWoS-Lå…ˆç«¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ‹¡å¼µãŒæ€¥ãƒ”ãƒƒãƒã§é€²ã¿ã€æ¤œæŸ»ãƒ»ãƒ†ã‚¹ãƒˆå·¥ç¨‹ã®éœ€è¦ãŒã•ã‚‰ã«æ‹¡å¤§ã€‚ã‚¢ãƒ‰ãƒãƒ³ãƒ†ã‚¹ãƒˆãƒ»æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³åŒæ–¹ã¸ã®æ©æµãŒç¶™ç¶šã€‚",
   impacts:[{label:"6857 â–²å¼·æ°—",cls:"imp-up"},{label:"8035 â–²å¼·æ°—",cls:"imp-up"},{label:"6146 â–²ä¸­ç«‹ã€œå¼·æ°—",cls:"imp-watch"}]},
  {cat:"cat-macro",catLabel:"ç‚ºæ›¿ãƒ»ãƒã‚¯ãƒ­",title:"æ—¥éŠ€è¿½åŠ åˆ©ä¸Šã’è¦³æ¸¬ãŒå†æµ®ä¸Šã€è¼¸å‡ºæ¯”ç‡ã®é«˜ã„éŠ˜æŸ„ã«é€†é¢¨",date:"2026-02-15",
   body:"æ—¥éŠ€ãŒ2026å¹´å†…ã®è¿½åŠ åˆ©ä¸Šã’ã‚’æ¤œè¨ã¨ã®å ±é“ãŒç›¸æ¬¡ãã€‚åŠå°ä½“è£…ç½®ãƒ»ææ–™ãƒ¡ãƒ¼ã‚«ãƒ¼ã¯è¼¸å‡ºæ¯”ç‡ãŒé«˜ãã€1å††ã®å††é«˜ã§å–¶æ¥­åˆ©ç›ŠãŒæ•°åå„„å††è¦æ¨¡ã§æ¸›å°‘ã™ã‚‹è©¦ç®—ãŒã‚ã‚‹ã€‚ç‰¹ã«ãƒ‰ãƒ«å»ºã¦å£²ä¸Šæ¯”ç‡ã®é«˜ã„6857ï¼ˆç´„80%ï¼‰ãƒ»8035ï¼ˆç´„90%ï¼‰ã«è¦æ³¨æ„ã€‚",
   impacts:[{label:"6857 â–¼è¦æ³¨æ„",cls:"imp-down"},{label:"8035 â–¼è¦æ³¨æ„",cls:"imp-down"},{label:"6871 â–¼å½±éŸ¿è»½å¾®",cls:"imp-neutral"}]},
  {cat:"cat-policy",catLabel:"æ”¿ç­–ãƒ»è¦åˆ¶",title:"ãƒˆãƒ©ãƒ³ãƒ—æ”¿æ¨©ãŒå¯¾ä¸­åŠå°ä½“è¦åˆ¶ã‚’ã•ã‚‰ã«å³æ ¼åŒ–ã€åŒç›Ÿå›½ã«å”èª¿è¦è«‹",date:"2026-02-14",
   body:"ãƒˆãƒ©ãƒ³ãƒ—æ”¿æ¨©ãŒæ—¥æœ¬ãƒ»ã‚ªãƒ©ãƒ³ãƒ€ãªã©ã«ä¸­å›½å‘ã‘åŠå°ä½“è£…ç½®è¼¸å‡ºã®è¿½åŠ è¦åˆ¶ã‚’è¦è«‹ã€‚æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³ã®ä¸­å›½å‘ã‘å£²ä¸Šæ¯”ç‡ï¼ˆç´„40%ï¼‰ãŒå¤§ããªãƒªã‚¹ã‚¯è¦å› ã€‚ä»£æ›¿éœ€è¦ã®éŸ“å›½ãƒ»å°æ¹¾å‘ã‘ã‚·ãƒ•ãƒˆã«æœŸå¾…ã‚‚ã€çŸ­æœŸçš„ãªæ¥­ç¸¾ã¸ã®å½±éŸ¿ã¯ä¸å¯é¿ã€‚",
   impacts:[{label:"8035 â–¼ãƒªã‚¹ã‚¯å¤§",cls:"imp-down"},{label:"6857 â–¼ãƒªã‚¹ã‚¯å°",cls:"imp-neutral"},{label:"6871 âˆ’ é™å®šçš„",cls:"imp-neutral"}]},
  {cat:"cat-supply",catLabel:"ä¾›çµ¦å‹•å‘",title:"TSMC 2nmï¼ˆN2ï¼‰æœ¬æ ¼é‡ç”£ã§ãƒ—ãƒ­ãƒ¼ãƒ–ã‚«ãƒ¼ãƒ‰æ›´æ–°ã‚µã‚¤ã‚¯ãƒ«ãŒçŸ­ç¸®",date:"2026-02-12",
   body:"TSMCãŒN2ãƒ—ãƒ­ã‚»ã‚¹ã®é‡ç”£ã‚’æœ¬æ ¼åŒ–ã€‚å¾®ç´°åŒ–ã«ä¼´ã„ãƒ—ãƒ­ãƒ¼ãƒ–ã‚«ãƒ¼ãƒ‰ã®æ¥è§¦é‡ãƒ”ãƒƒãƒãŒæ›´ã«ç¸®å°ã—ã€é«˜ç²¾åº¦ã‚«ãƒ¼ãƒ‰ã¸ã®æ›´æ–°ã‚µã‚¤ã‚¯ãƒ«ãŒåŠ é€Ÿã€‚æ—¥æœ¬ãƒã‚¤ã‚¯ãƒ­ãƒ‹ã‚¯ã‚¹ï¼ˆ6871ï¼‰ãƒ»æ—¥æœ¬é›»å­ææ–™ï¼ˆ6855ï¼‰ã¸ã®ä¸­é•·æœŸçš„ãªå—æ³¨å¢—ãŒè¦‹è¾¼ã¾ã‚Œã‚‹ã€‚",
   impacts:[{label:"6871 â–²ä¸­ã€œé•·æœŸå¼·æ°—",cls:"imp-up"},{label:"6855 â–²ä¸­ã€œé•·æœŸå¼·æ°—",cls:"imp-up"},{label:"6857 â–²ä¸­ç«‹ã€œå¼·æ°—",cls:"imp-watch"}]},
  {cat:"cat-demand",catLabel:"éœ€è¦å‹•å‘",title:"NANDå¸‚æ³ãŒåº•æ‰“ã¡ã€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºSSDãŒå›å¾©ã‚’ç‰½å¼•",date:"2026-02-10",
   body:"AIå­¦ç¿’ç”¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸éœ€è¦ãŒæ—ºç››ã§ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºSSDã®å˜ä¾¡ãŒå›å¾©ã€‚ãŸã ã—ã‚¹ãƒãƒ›ãƒ»PCå‘ã‘ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒãƒ¼NANDã¯ä¾ç„¶ä½èª¿ã€‚6871ãƒ»6855ã®NANDå‘ã‘ãƒ—ãƒ­ãƒ¼ãƒ–ã‚«ãƒ¼ãƒ‰å—æ³¨ã¯åº•æ‰“ã¡åˆæœŸæ®µéšã§ã€æœ¬æ ¼å›å¾©ã¯2026å¹´å¾ŒåŠã¨è¦‹ã‚‰ã‚Œã‚‹ã€‚",
   impacts:[{label:"6871 â–³â†’â—‹ å›å¾©åˆæœŸ",cls:"imp-watch"},{label:"6855 â–³â†’â—‹ å›å¾©åˆæœŸ",cls:"imp-watch"},{label:"6857 âˆ’ DRAMä¸»ä½“",cls:"imp-neutral"}]},
];

// ===== STATE =====
let stocks=BASE.map(s=>({...s,apiStatus:"pending",prevClose:null,apiError:""}));
let sortKey="ticker",sortAsc=true,query="",fetchCooldown=false;

// ===== UTILS =====
function fmtVol(n){if(!n||n<=0)return"--";if(n>=1e6)return(n/1e6).toFixed(1)+"M";if(n>=1e3)return(n/1e3).toFixed(0)+"K";return n;}
function fmtPrice(p){if(!p||p<=0)return"--";return p.toLocaleString("ja-JP",{minimumFractionDigits:0,maximumFractionDigits:0});}
function clamp(v,lo,hi){return Math.min(hi,Math.max(lo,v));}

// ===== DYNAMIC FACTOR COMPUTATION (tied to live API data + market bar) =====
function computeFactors(){
  const g=k=>stocks.find(s=>s.ticker===k);
  const chg=k=>{const s=g(k);return s?.apiStatus==="live"?(s.change||0):0;};
  const jpy=MARKET.usdjpy.val, sox=MARKET.sox.val, soxC=MARKET.sox.chg;
  const c6857=chg("6857"),c6871=chg("6871"),c6855=chg("6855");
  const anyLive=stocks.some(s=>s.apiStatus==="live");
  const src=anyLive?`APIå–å¾—å€¤ãƒ»${new Date().toLocaleTimeString("ja-JP")}æ›´æ–°`:"å‚è€ƒå€¤";

  // 1. HBMéœ€è¦ â† 6857ãŒä¸»ã‚·ã‚°ãƒŠãƒ«
  const hbmM=clamp(83+c6857*2.5,40,97);
  const hbmC=hbmM>=72?"up":hbmM>=52?"neutral":"down";
  const hbmV=hbmM>=90?"æ¥µã‚ã¦å¼·ã„":hbmM>=74?"å¼·ã„":hbmM>=56?"ã‚„ã‚„å¼±ã„":"å¼±ã„";

  // 2. DRAMå¸‚æ³ â† 6871ãŒä¸»ã‚·ã‚°ãƒŠãƒ«
  const dramM=clamp(68+c6871*3.5,28,93);
  const dramC=dramM>=65?"up":dramM>=46?"neutral":"down";
  const dramV=dramM>=80?"å›å¾©ãƒ»å …èª¿":dramM>=62?"ç·©ã‚„ã‹å›å¾©":dramM>=44?"æ¨ªã°ã„":"ä½è¿·";

  // 3. NANDå¸‚æ³ â† 6855ãŒä¸»ã‚·ã‚°ãƒŠãƒ«ï¼ˆDRAMã‚ˆã‚Šé…è¡Œï¼‰
  const nandM=clamp(52+c6855*3.5,18,86);
  const nandC=nandM>=62?"up":nandM>=40?"neutral":"down";
  const nandV=nandM>=72?"å›å¾©åŸºèª¿":nandM>=55?"åº•æ‰“ã¡ã€œå›å¾©åˆæœŸ":nandM>=36?"åº•æ‰“ã¡æ„Ÿ":"ä½è¿·ç¶™ç¶š";

  // 4. USD/JPY â† ãƒãƒ¼ã‚±ãƒƒãƒˆãƒãƒ¼ã®å®Ÿå€¤ã‹ã‚‰ç›´æ¥ç®—å‡º
  const jpyM=clamp((jpy-140)/18*100,0,100);
  const jpyC=jpy>=155?"up":jpy>=148?"neutral":"down";
  const jpyI=jpy>=155?"è¼¸å‡ºä¼æ¥­ã«è¿½ã„é¢¨":jpy>=148?"ä¸­ç«‹åœ":jpy>=142?"å††é«˜é€²è¡Œãƒ»è¦æ³¨æ„":"æ€¥é€Ÿãªå††é«˜ãƒ»é€†é¢¨";

  // 5. SOX â† ãƒãƒ¼ã‚±ãƒƒãƒˆãƒãƒ¼ã®å¤‰åŒ–ç‡ã‹ã‚‰ç®—å‡º
  const soxM=clamp(62+soxC*9,18,96);
  const soxC2=soxC>=0.5?"up":soxC>=-0.5?"neutral":"down";
  const soxV=soxC>=2?"æ€¥é¨°":soxC>=0.5?"ä¸Šæ˜‡åŸºèª¿":soxC>=-0.5?"æ¨ªã°ã„":soxC>=-2?"ä¸‹è½":"æ€¥è½";

  // 6. å¯¾ä¸­è¦åˆ¶ â† æ§‹é€ ãƒªã‚¹ã‚¯ãªã®ã§å›ºå®šï¼ˆé«˜ãƒªã‚¹ã‚¯ç¶­æŒï¼‰
  return[
    {label:"HBMéœ€è¦æ°´æº–",val:hbmV,cls:hbmC,meter:Math.round(hbmM),
     desc:`HBM4é‡ç”£ç§»è¡ŒãŒåŠ é€Ÿã€‚AIã‚µãƒ¼ãƒãƒ¼å‘ã‘ãƒ†ã‚¹ãƒˆå·¥ç¨‹ã¯é€šå¸¸DRAMã®5ã€œ7å€ã®æ™‚é–“ã‚’è¦ã™ã‚‹ã€‚6857æ ªä¾¡ï¼ˆ${c6857>=0?"+":""}${c6857.toFixed(2)}%ï¼‰ãŒéœ€è¦å¼·åº¦ã‚’ç¤ºå”†ã€‚ï¼ˆ${src}ï¼‰`,
     chips:[{l:"6857 â—",c:"imp-up"},{l:"6871 â—‹",c:"imp-watch"}]},
    {label:"DRAMå¸‚æ³",val:dramV,cls:dramC,meter:Math.round(dramM),
     desc:`DDR5æ™®åŠãƒ»HPCå‘ã‘éœ€è¦ã‚’èƒŒæ™¯ã«å›å¾©åŸºèª¿ã€‚6871æ ªä¾¡ï¼ˆ${c6871>=0?"+":""}${c6871.toFixed(2)}%ï¼‰ãŒDRAMå‘ã‘ãƒ—ãƒ­ãƒ¼ãƒ–ã‚«ãƒ¼ãƒ‰å—æ³¨ã®å…ˆè¡ŒæŒ‡æ¨™ã¨ãªã‚‹ã€‚ï¼ˆ${src}ï¼‰`,
     chips:[{l:"6871 â—‹",c:"imp-watch"},{l:"6855 â—‹",c:"imp-watch"}]},
    {label:"NANDå¸‚æ³",val:nandV,cls:nandC,meter:Math.round(nandM),
     desc:`ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºSSDç‰½å¼•ã§åº•æ‰“ã¡ã€‚6855æ ªä¾¡ï¼ˆ${c6855>=0?"+":""}${c6855.toFixed(2)}%ï¼‰ãŒNANDå‘ã‘ãƒ—ãƒ­ãƒ¼ãƒ–ã‚«ãƒ¼ãƒ‰å¸‚æ³ã‚’åæ˜ ã€‚ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒãƒ¼å‘ã‘ã¯ä¾ç„¶è»Ÿèª¿ã€‚ï¼ˆ${src}ï¼‰`,
     chips:[{l:"6871 â–³â†’â—‹",c:"imp-watch"},{l:"6855 â–³â†’â—‹",c:"imp-watch"}]},
    {label:"USD/JPYï¼ˆå††å®‰åº¦ï¼‰",val:jpy.toFixed(1)+"å††å°",cls:jpyC,meter:Math.round(jpyM),
     desc:`ç¾åœ¨${jpy.toFixed(2)}å††ã€‚${jpyI}ã€‚6857ã¯æµ·å¤–å£²ä¸Šæ¯”ç‡ç´„80%ã§æ„Ÿå¿œåº¦ãŒé«˜ãã€1å††ã®å††é«˜ã§å–¶æ¥­åˆ©ç›Šç´„50å„„å††æ¸›å°‘ã®è©¦ç®—ãŒã‚ã‚‹ã€‚ï¼ˆãƒãƒ¼ã‚±ãƒƒãƒˆãƒãƒ¼å‚ç…§ï¼‰`,
     chips:[{l:"6857 æ„Ÿå¿œåº¦â—",c:jpyC==="up"?"imp-up":jpyC==="neutral"?"imp-neutral":"imp-down"},{l:"8035 æ„Ÿå¿œåº¦â—",c:jpyC==="up"?"imp-up":jpyC==="neutral"?"imp-neutral":"imp-down"}]},
    {label:"SOXæŒ‡æ•°ãƒˆãƒ¬ãƒ³ãƒ‰",val:`${soxV}ï¼ˆ${soxC>=0?"+":""}${soxC.toFixed(2)}%ï¼‰`,cls:soxC2,meter:Math.round(soxM),
     desc:`SOX ${sox.toLocaleString()}ptï¼ˆå‰æ—¥æ¯”${soxC>=0?"+":""}${soxC.toFixed(2)}%ï¼‰ã€‚SOXã¨æ—¥æœ¬åŠå°ä½“æ ªã®ç›¸é–¢ã¯é«˜ãï¼ˆ~0.8ï¼‰ã€ç¿Œæ—¥ã®æ ªä¾¡æ–¹å‘æ€§ã®å…ˆè¡ŒæŒ‡æ¨™ã¨ãªã‚‹ã€‚ï¼ˆãƒãƒ¼ã‚±ãƒƒãƒˆãƒãƒ¼å‚ç…§ï¼‰`,
     chips:[{l:"6857 é«˜é€£å‹•",c:soxC2==="up"?"imp-up":"imp-down"},{l:"8035 é«˜é€£å‹•",c:soxC2==="up"?"imp-up":"imp-down"}]},
    {label:"å¯¾ä¸­è¼¸å‡ºè¦åˆ¶ãƒªã‚¹ã‚¯",val:"è¦åˆ¶å¼·åŒ–ä¸­",cls:"down",meter:80,
     desc:"ãƒˆãƒ©ãƒ³ãƒ—æ”¿æ¨©ãŒåŒç›Ÿå›½ã«è¦åˆ¶å”èª¿ã‚’è¦è«‹ã€‚ä¸­å›½å‘ã‘å£²ä¸Šæ¯”ç‡ã®é«˜ã„8035ï¼ˆç´„40%ï¼‰ãƒ»6857ï¼ˆç´„15%ï¼‰ã«ç¶™ç¶šãƒªã‚¹ã‚¯ã€‚6871ãƒ»6855ã¸ã®ç›´æ¥å½±éŸ¿ã¯è»½å¾®ã ãŒã€é¡§å®¢ã®è¨­å‚™æŠ•è³‡æŠ‘åˆ¶ãŒé–“æ¥æ³¢åŠã—ã†ã‚‹ã€‚",
     chips:[{l:"8035 è¦æ³¨æ„",c:"imp-down"},{l:"6857 è»½å¾®",c:"imp-neutral"}]},
  ];
}

// ===== MARKET BAR SIMULATION =====
function fluctuateMarket(){
  MARKET.sox.val=+(MARKET.sox.val+(Math.random()-.5)*12).toFixed(0);
  MARKET.sox.chg=+(MARKET.sox.chg+(Math.random()-.5)*.18).toFixed(2);
  MARKET.usdjpy.val=+(MARKET.usdjpy.val+(Math.random()-.5)*.1).toFixed(2);
  MARKET.usdjpy.chg=+(MARKET.usdjpy.chg+(Math.random()-.5)*.06).toFixed(2);
  MARKET.nk.val=+(MARKET.nk.val+(Math.random()-.5)*60).toFixed(0);
  MARKET.nk.chg=+(MARKET.nk.chg+(Math.random()-.5)*.1).toFixed(2);
  MARKET.nvda.val=+(MARKET.nvda.val+(Math.random()-.5)*6).toFixed(2);
  MARKET.nvda.chg=+(MARKET.nvda.chg+(Math.random()-.5)*.2).toFixed(2);
}

// ===== RENDER MARKET BAR =====
function renderMarket(){
  const m=MARKET;
  const set=(id,val,chg,prefix="")=>{
    const u=chg>=0;
    const ve=document.getElementById(id+"-val");
    const ce=document.getElementById(id+"-chg");
    if(ve)ve.textContent=prefix+(typeof val==="number"&&val>=1000?val.toLocaleString():val);
    if(ce){ce.textContent=(u?"+":"")+chg.toFixed(2)+"%";ce.className="mchg "+(u?"bg-up":"bg-down");}
  };
  set("sox",m.sox.val,m.sox.chg);
  set("nk",m.nk.val,m.nk.chg);
  set("nq",m.nq.val,m.nq.chg);
  const uv=document.getElementById("usdjpy-val"),uc=document.getElementById("usdjpy-chg");
  if(uv)uv.textContent=m.usdjpy.val.toFixed(2);
  if(uc){uc.textContent=(m.usdjpy.chg>=0?"+":"")+m.usdjpy.chg.toFixed(2)+"%";uc.className="mchg "+(m.usdjpy.chg>=0?"bg-up":"bg-down");}
  const tv=document.getElementById("tsm-val"),tc=document.getElementById("tsm-chg");
  if(tv)tv.textContent="$"+m.tsm.val.toFixed(2);
  if(tc){tc.textContent=(m.tsm.chg>=0?"+":"")+m.tsm.chg.toFixed(2)+"%";tc.className="mchg "+(m.tsm.chg>=0?"bg-up":"bg-down");}
  const nv=document.getElementById("nvda-val"),nc=document.getElementById("nvda-chg");
  if(nv)nv.textContent="$"+m.nvda.val.toFixed(2);
  if(nc){nc.textContent=(m.nvda.chg>=0?"+":"")+m.nvda.chg.toFixed(2)+"%";nc.className="mchg "+(m.nvda.chg>=0?"bg-up":"bg-down");}
}

// ===== YAHOO FINANCE API =====
const PROXY="https://corsproxy.io/?url=";

async function fetchYahoo(yfSym){
  const url=`https://query1.finance.yahoo.com/v8/finance/chart/${yfSym}?interval=1d&range=2d&includePrePost=false`;
  let res,data;
  try{
    res=await fetch(url,{signal:AbortSignal.timeout(8000)});
    if(res.ok)data=await res.json();
  }catch(e){
    try{
      res=await fetch(PROXY+encodeURIComponent(url),{signal:AbortSignal.timeout(12000)});
      if(res.ok){const raw=await res.json();data=raw?.contents?JSON.parse(raw.contents):raw;}
    }catch(e2){throw new Error("NETWORK:"+e2.message);}
  }
  if(!res||!res.ok)throw new Error("HTTP:"+(res?.status||"?")+" "+(res?.statusText||""));
  const result=data?.chart?.result?.[0];
  if(!result){const ae=data?.chart?.error?.description;throw new Error("NODATA:"+(ae||"ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"));}
  const meta=result.meta;
  const price=meta.regularMarketPrice??meta.price;
  const prevClose=meta.previousClose??meta.chartPreviousClose;
  if(!price)throw new Error("NODATA:æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
  const changePct=prevClose?((price-prevClose)/prevClose*100):0;
  return{price:+price.toFixed(0),changePct:+changePct.toFixed(2),prevClose:prevClose?+prevClose.toFixed(0):null,volume:meta.regularMarketVolume||0};
}

// ===== FOCUS CARD HELPERS =====
function setFocusLoading(code){
  const st=document.getElementById("st"+code),err=document.getElementById("err"+code);
  const pc=document.getElementById("p"+code),cc=document.getElementById("c"+code);
  if(st){st.className="api-status loading";st.innerHTML='<span class="dot-pulse"></span>å–å¾—ä¸­...';}
  if(err)err.style.display="none";
  if(pc)pc.innerHTML='-- <span>å††</span>';
  if(cc){cc.textContent="--";cc.className="fc-change bg-neutral neutral";}
}
function setFocusLive(code,price,changePct,prevClose){
  const isUp=changePct>=0;
  const st=document.getElementById("st"+code),err=document.getElementById("err"+code);
  const pc=document.getElementById("p"+code),cc=document.getElementById("c"+code),pv=document.getElementById("prev"+code);
  if(st){st.className="api-status live";st.innerHTML='<span class="dot-pulse"></span>LIVE';}
  if(err)err.style.display="none";
  if(pc)pc.innerHTML=price.toLocaleString("ja-JP")+" <span>å††</span>";
  if(cc){cc.textContent=(isUp?"â–² +":"â–¼ ")+Math.abs(changePct).toFixed(2)+"%";cc.className="fc-change "+(isUp?"bg-up up":"bg-down down");}
  if(pv)pv.textContent=prevClose?prevClose.toLocaleString("ja-JP")+"å††":"--";
}
function setFocusError(code,msg,hint){
  const st=document.getElementById("st"+code),err=document.getElementById("err"+code),em=document.getElementById("errmsg"+code);
  if(st){st.className="api-status error";st.textContent="å–å¾—å¤±æ•—";}
  if(err)err.style.display="block";
  if(em)em.innerHTML=`<b>${msg}</b><br>${hint}`;
}
function parseApiError(raw){
  if(raw.startsWith("HTTP:"))return{msg:"HTTPã‚¨ãƒ©ãƒ¼: "+raw.replace("HTTP:",""),hint:"Yahoo Finance APIãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚"};
  if(raw.startsWith("NODATA:"))return{msg:"ãƒ‡ãƒ¼ã‚¿ãªã—",hint:raw.replace("NODATA:","")};
  if(raw.includes("NETWORK:")||raw.includes("Failed to fetch")||raw.includes("NetworkError"))
    return{msg:"æ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼ˆCORSã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰",hint:"ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã«ã‚ˆã‚Šå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>ã€ŒYahoo Finance ã§ç¢ºèªã€ãƒªãƒ³ã‚¯ã‹ã‚‰å®Ÿéš›ã®æ ªä¾¡ã‚’ã”å‚ç…§ãã ã•ã„ã€‚"};
  if(raw.includes("timeout")||raw.includes("AbortError"))return{msg:"ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ",hint:"APIã¸ã®æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã‚’ç¢ºèªã—å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚"};
  return{msg:"ä¸æ˜ãªã‚¨ãƒ©ãƒ¼",hint:raw.slice(0,100)};
}

// ===== TABLE STATUS =====
function updateTableStatus(state,ok,total){
  const badge=document.getElementById("tbl-status-badge"),desc=document.getElementById("tbl-status-desc");
  if(state==="loading"){
    if(badge){badge.className="mock-badge";badge.textContent="å–å¾—ä¸­...";}
    if(desc)desc.textContent="Yahoo Finance APIã‚ˆã‚Šå…¨éŠ˜æŸ„ã®æ ªä¾¡ã‚’å–å¾—ä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚";
  }else if(state==="live"){
    if(badge){badge.style.cssText="font-size:10px;background:rgba(46,204,113,.12);color:#2ecc71;border:1px solid rgba(46,204,113,.2);padding:2px 8px;border-radius:4px;font-weight:600;vertical-align:middle;margin-left:8px";badge.textContent="Yahoo Finance LIVE";}
    if(desc)desc.textContent=`å…¨${total}éŠ˜æŸ„ã®æ ªä¾¡ãƒ»å‰æ—¥æ¯”ã‚’Yahoo Finance APIã‚ˆã‚Šå–å¾—æ¸ˆï¼ˆ${new Date().toLocaleTimeString("ja-JP")}æ›´æ–°ï¼‰ã€‚å‡ºæ¥é«˜ãƒ»æ™‚ä¾¡ç·é¡ã¯å‚è€ƒå€¤ã€‚`;
  }else if(state==="partial"){
    if(badge){badge.style.cssText="font-size:10px;background:rgba(247,183,79,.12);color:#f7b74f;border:1px solid rgba(247,183,79,.2);padding:2px 8px;border-radius:4px;font-weight:600;vertical-align:middle;margin-left:8px";badge.textContent=`${ok}/${total}éŠ˜æŸ„å–å¾—æ¸ˆ`;}
    if(desc)desc.textContent=`${ok}/${total}éŠ˜æŸ„ã®æ ªä¾¡ã‚’Yahoo Finance APIã‚ˆã‚Šå–å¾—ã€‚ERRéŠ˜æŸ„ã¯Yahoo Financeãƒªãƒ³ã‚¯ã‚ˆã‚Šã”ç¢ºèªãã ã•ã„ã€‚`;
  }else{
    if(badge){badge.style.cssText="font-size:10px;background:rgba(231,76,60,.12);color:#e74c3c;border:1px solid rgba(231,76,60,.2);padding:2px 8px;border-radius:4px;font-weight:600;vertical-align:middle;margin-left:8px";badge.textContent="APIå–å¾—å¤±æ•—";}
    if(desc)desc.textContent="Yahoo Finance APIã‹ã‚‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®CORSåˆ¶é™ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å„éŠ˜æŸ„ã®ERRãƒãƒƒã‚¸ã‚’ã”ç¢ºèªãã ã•ã„ã€‚";
  }
}

// ===== FETCH ALL PRICES =====
async function fetchAllPrices(){
  if(fetchCooldown){return;}
  fetchCooldown=true;setTimeout(()=>{fetchCooldown=false;},30000);
  stocks.forEach(s=>{s.apiStatus="pending";});
  stocks.filter(s=>s.focus).forEach(s=>setFocusLoading(s.ticker));
  updateTableStatus("loading");renderTable();
  let ok=0;
  await Promise.allSettled(stocks.map(async s=>{
    try{
      const {price,changePct,prevClose,volume}=await fetchYahoo(s.yfSym);
      s.price=price;s.change=changePct;s.prevClose=prevClose;
      if(volume>0)s.volume=volume;
      s.apiStatus="live";s.apiError="";ok++;
      if(s.focus)setFocusLive(s.ticker,price,changePct,prevClose);
    }catch(err){
      s.apiStatus="error";s.apiError=err.message;
      if(s.focus){const{msg,hint}=parseApiError(err.message||"");setFocusError(s.ticker,msg,hint);}
    }
    renderTable();renderSummary();renderFactors();
  }));
  updateTableStatus(ok===stocks.length?"live":ok>0?"partial":"error",ok,stocks.length);
}

// ===== RENDER TABLE =====
function renderTable(){
  let list=stocks.filter(s=>s.ticker.toLowerCase().includes(query)||s.name.toLowerCase().includes(query)||(s.en&&s.en.toLowerCase().includes(query)));
  list.sort((a,b)=>{let va=a[sortKey],vb=b[sortKey];if(typeof va==="string"){va=va.toLowerCase();vb=vb.toLowerCase();}return sortAsc?(va<vb?-1:va>vb?1:0):(va>vb?-1:va<vb?1:0);});
  ["ticker","price","change","volume","cap"].forEach(k=>{
    const el=document.getElementById("sa-"+k);if(!el)return;
    if(k===sortKey){el.textContent=sortAsc?"â–²":"â–¼";el.classList.add("active");}else{el.textContent="â–²";el.classList.remove("active");}
  });
  const tbody=document.getElementById("tbody"),nr=document.getElementById("no-results");
  if(!list.length){tbody.innerHTML="";nr.style.display="block";return;}
  nr.style.display="none";
  tbody.innerHTML=list.map(s=>{
    const isUp=s.change>=0;
    const badge=s.apiStatus==="pending"
      ?`<span class="badge bg-neutral neutral" style="font-size:11px">--</span>`
      :`<span class="badge ${isUp?"bg-up":"bg-down"}">${isUp?"â–² +":"â–¼ "}${Math.abs(s.change).toFixed(2)}%</span>`;
    const priceCell=s.apiStatus==="pending"?`<span style="color:#555">å–å¾—ä¸­</span>`:`Â¥${fmtPrice(s.price)}`;
    const stLabel={pending:"å–å¾—ä¸­",live:"LIVE",error:"ERR"}[s.apiStatus]||"--";
    return`<tr class="${s.focus?"highlight-row":""}">
      <td>
        <span class="t-star" style="background:${s.color}"></span>
        <span class="t-ticker">${s.ticker}</span>
        <span class="row-status ${s.apiStatus}">${stLabel}</span>
        <div class="t-name" style="margin-left:14px">${s.name}</div>
      </td>
      <td class="r t-price">${priceCell}</td>
      <td class="r">${badge}</td>
      <td class="r hide-sm neutral">${fmtVol(s.volume)}</td>
      <td class="r hide-sm neutral">${s.cap>=1000?(s.cap/1000).toFixed(1)+"å…†":s.cap+"å„„"}</td>
      <td class="r hide-sm"><span style="font-size:11px;color:#555">${s.sector}</span></td>
    </tr>`;
  }).join("");
}

// ===== RENDER SUMMARY =====
function renderSummary(){
  const live=stocks.filter(s=>s.apiStatus==="live");
  const base=live.length?live:stocks;
  const g=base.filter(s=>s.change>=0).length,l=base.length-g;
  document.getElementById("s-total").textContent=stocks.length;
  document.getElementById("s-up").textContent=g;
  document.getElementById("s-dn").textContent=l;
  document.getElementById("s-up-p").textContent=base.length?Math.round(g/base.length*100)+"% ä¸Šæ˜‡":"--";
  document.getElementById("s-dn-p").textContent=base.length?Math.round(l/base.length*100)+"% ä¸‹è½":"--";
  document.getElementById("s-time").textContent=new Date().toLocaleTimeString("ja-JP");
}

// ===== RENDER FACTORS (dynamic â€” called after each stock update) =====
function renderFactors(){
  const factors=computeFactors();
  document.getElementById("factors-grid").innerHTML=factors.map(f=>`
    <div class="factor-card">
      <div class="factor-label">${f.label}</div>
      <div class="factor-val ${f.cls}">${f.val}</div>
      <div class="meter"><div class="meter-fill ${f.cls}" style="width:${f.meter}%"></div></div>
      <div class="factor-desc">${f.desc}</div>
      <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:5px">
        ${f.chips.map(c=>`<span class="impact-chip ${c.c}">${c.l}</span>`).join("")}
      </div>
    </div>`).join("");
}

// ===== RENDER NEWS =====
function renderNews(){
  document.getElementById("news-grid").innerHTML=NEWS.map(n=>`
    <div class="news-card">
      <div class="news-header">
        <div><span class="news-cat ${n.cat}">${n.catLabel}</span>
        <div class="news-title" style="margin-top:6px">${n.title}</div></div>
        <div class="news-date">${n.date}</div>
      </div>
      <div class="news-body">${n.body}</div>
      <div class="news-impact">${n.impacts.map(i=>`<span class="impact-chip ${i.cls}">${i.label}</span>`).join("")}</div>
    </div>`).join("");
}

// ===== CLOCK / SORT / SEARCH =====
function updateClock(){document.getElementById("clock").textContent=new Date().toLocaleTimeString("ja-JP");}
function sort(key){if(sortKey===key)sortAsc=!sortAsc;else{sortKey=key;sortAsc=true;}renderTable();}
document.getElementById("search").addEventListener("input",e=>{query=e.target.value.toLowerCase().trim();renderTable();});

// ===== INIT =====
renderNews();
renderMarket();
renderTable();
renderSummary();
renderFactors();
setInterval(updateClock,1000);
// ãƒãƒ¼ã‚±ãƒƒãƒˆãƒãƒ¼ã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ5ç§’ã”ã¨ï¼‰ï¼‹ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼å†è¨ˆç®—
setInterval(()=>{fluctuateMarket();renderMarket();renderFactors();},5000);
// APIã¯90ç§’ã”ã¨ã«è‡ªå‹•å†å–å¾—
setInterval(fetchAllPrices,90000);
// åˆå›APIå–å¾—
fetchAllPrices();
</script>
</body>
</html>
